# 负载均衡

对一个分布式系统来说，有很多可以组合使用的组件，比如`桶`(主键管理系统，给各个系统配置需要的主键，比如`redis`做存储，快速给各个系统分配键值对)。负载均衡也可以视作为分布式系统的组件。

负载均衡好处:

1. 帮助我们对系统服务分流，以此来提高应用(站点地址、数据库地址、服务地址)的响应能力和可达性。解决`单点错误`问题。
2. 追踪资源(服务、资源)状态。如果一个应用挂掉了，负载均衡算法将不再分配流量到这个应用。
3. 更好的用户体验，用户访问更快，更不容易发生阻断性问题。
4. 一个聪明的负载均衡算法甚至可以预测到可能发生的流量瓶颈。
5. 释放管理者精力。单点应用会有更大的任务处理压力、更大的流量载荷、更慢的响应时间。

通常负载均衡服务会处在用户和服务之间，借用一些算法的帮助来把客户端发起的请求导流到不同的服务器。

```
client -                                  - server A
        |                                |
client -+->  internet -> load balancer ->+- server B
        |                                |
client -                                  - server C
```

但是，我们也可以通过增加负载均衡层数来确保系统获得更大的可扩展性和容错性。

```
                            - web server -                       - application server -                       - database server
                           |              |                     |                      |                     |
client -> load balancer -> +              + -> load balancer -> +                      + -> load balancer -> +
                           |              |                     |                      |                     |
                            - web server -                       - application server -                       - database server
```

## 负载均衡算法

**那么负载均衡是如何选择服务的呢？**

1. 确保每个服务可达。**`状态检测`(health check)**，每隔一段时间就尝试连接后台服务，如果服务挂掉了，流量就不会导入到该服务器，而会分配到其他健康的服务器。
2. 分配算法。

  - 最少连接方法。检测那些最少被访问的服务器，把流量导入到访问量最少的服务器，以获得最快的处理能力。这种方法在存在大量客服端连接的时候很有效。
  - 最少响应时间方法。检测那些能够在心跳中最快给出响应的服务器来处理当前访问请求。
  - 最少带宽方法。选择当前在线服务器中占用最少带宽的服务器。
  - 轮询法。从服务器中选择一部分，循环发送请求。适用于服务器无特殊差别、请求量小的系统。
  - 权重轮询法。轮询法的改进，每个服务器有一定的权重，比如2:1，则第一个服务器会比第二个服务器多33%的访问量。
  - `IP HASH`，哈希法。根据每个请求的`IP`地址来计算导向的服务器。

## 负载均衡主备

负载均衡解决了服务器的`单点错误`问题，但它自身却可能挂掉。因此，我们通常需要给负载均衡服务挂一个主备。

```

client                                                                  service
client -> internet -> load balancer(active) | load balancer(passive) -> service
client                                                                  service


```

